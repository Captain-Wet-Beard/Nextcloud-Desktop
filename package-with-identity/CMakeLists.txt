project (PackageWithIdentity)

set(APPX_MANIFEST_IDENTITY_VERSION ${MIRALL_VERSION_FOUR_COMPONENTS})
set(APPX_MANIFEST_IDENTITY_NAME "${APPLICATION_EXECUTABLE}.app")
set(APPX_MANIFEST_PUBLISHER "CN=SparsePackageTester")
set(APPX_MANIFEST_PACKAGE_NAME "${APPLICATION_SHORTNAME}")
set(APPX_MANIFEST_APPLICATION_ID "${APPLICATION_REV_DOMAIN}.${APPLICATION_EXECUTABLE}")
set(APPX_MANIFEST_APPLICAION_EXECUTABLE "${APPLICATION_EXECUTABLE}.exe")
set(APPX_MANIFEST_DISPLAY_NAME "${APPLICATION_NAME}")
set(APPX_MANIFEST_PUBLISHER_DISPLAY_NAME ${APPLICATION_VENDOR})

configure_file(AppxManifest.xml.in ${CMAKE_CURRENT_BINARY_DIR}/AppxManifest.xml)

add_custom_target(package-with-identity ALL
	COMMAND MakeAppx.exe pack /d ${CMAKE_CURRENT_BINARY_DIR} /p ${BIN_OUTPUT_DIRECTORY}/${WIN_IDENTITY_PACKAGE_NAME} /nv
    COMMENT "Creating ${APPX_MANIFEST_PACKAGE_NAME}..."
)

add_custom_command(
  TARGET package-with-identity POST_BUILD
  COMMAND SignTool.exe sign /fd SHA256 /a /f ${CMAKE_CURRENT_SOURCE_DIR}/SparsePackageTest.pfx /p qazXSW123 ${BIN_OUTPUT_DIRECTORY}/${WIN_IDENTITY_PACKAGE_NAME}
  COMMENT "Signing ${APPX_MANIFEST_PACKAGE_NAME}..."
)